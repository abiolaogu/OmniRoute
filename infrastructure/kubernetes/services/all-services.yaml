# Kubernetes Deployment Manifests for OmniRoute Services
# Namespace and common resources

---
apiVersion: v1
kind: Namespace
metadata:
  name: omniroute
  labels:
    name: omniroute
    istio-injection: enabled

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: omniroute-config
  namespace: omniroute
data:
  LOG_LEVEL: "info"
  ENVIRONMENT: "production"
  TIMEZONE: "Africa/Lagos"
  DEFAULT_CURRENCY: "NGN"

---
apiVersion: v1
kind: Secret
metadata:
  name: omniroute-secrets
  namespace: omniroute
type: Opaque
stringData:
  DATABASE_URL: "postgres://omniroute:${DB_PASSWORD}@yugabytedb:5433/omniroute?sslmode=require"
  REDIS_URL: "redis://dragonfly:6379"
  KAFKA_BROKERS: "redpanda:9092"
  JWT_SECRET: "${JWT_SECRET}"

---
# Auth Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth-service
  namespace: omniroute
  labels:
    app: auth-service
spec:
  replicas: 3
  selector:
    matchLabels:
      app: auth-service
  template:
    metadata:
      labels:
        app: auth-service
    spec:
      containers:
      - name: auth-service
        image: omniroute/auth-service:latest
        ports:
        - containerPort: 8100
        envFrom:
        - configMapRef:
            name: omniroute-config
        - secretRef:
            name: omniroute-secrets
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8100
          initialDelaySeconds: 10
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8100
          initialDelaySeconds: 5
          periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: auth-service
  namespace: omniroute
spec:
  selector:
    app: auth-service
  ports:
  - port: 8100
    targetPort: 8100
  type: ClusterIP

---
# Catalog Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: catalog-service
  namespace: omniroute
spec:
  replicas: 3
  selector:
    matchLabels:
      app: catalog-service
  template:
    metadata:
      labels:
        app: catalog-service
    spec:
      containers:
      - name: catalog-service
        image: omniroute/catalog-service:latest
        ports:
        - containerPort: 8101
        envFrom:
        - configMapRef:
            name: omniroute-config
        - secretRef:
            name: omniroute-secrets
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"

---
apiVersion: v1
kind: Service
metadata:
  name: catalog-service
  namespace: omniroute
spec:
  selector:
    app: catalog-service
  ports:
  - port: 8101
    targetPort: 8101

---
# Order Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: order-service
  namespace: omniroute
spec:
  replicas: 3
  selector:
    matchLabels:
      app: order-service
  template:
    metadata:
      labels:
        app: order-service
    spec:
      containers:
      - name: order-service
        image: omniroute/order-service:latest
        ports:
        - containerPort: 8102
        envFrom:
        - configMapRef:
            name: omniroute-config
        - secretRef:
            name: omniroute-secrets
        resources:
          requests:
            memory: "256Mi"
            cpu: "200m"
          limits:
            memory: "1Gi"
            cpu: "1"

---
apiVersion: v1
kind: Service
metadata:
  name: order-service
  namespace: omniroute
spec:
  selector:
    app: order-service
  ports:
  - port: 8102
    targetPort: 8102

---
# Pricing Engine
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pricing-engine
  namespace: omniroute
spec:
  replicas: 3
  selector:
    matchLabels:
      app: pricing-engine
  template:
    metadata:
      labels:
        app: pricing-engine
    spec:
      containers:
      - name: pricing-engine
        image: omniroute/pricing-engine:latest
        ports:
        - containerPort: 8081
        envFrom:
        - configMapRef:
            name: omniroute-config
        - secretRef:
            name: omniroute-secrets
        resources:
          requests:
            memory: "256Mi"
            cpu: "200m"
          limits:
            memory: "1Gi"
            cpu: "1"

---
apiVersion: v1
kind: Service
metadata:
  name: pricing-engine
  namespace: omniroute
spec:
  selector:
    app: pricing-engine
  ports:
  - port: 8081
    targetPort: 8081

---
# Gig Platform
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gig-platform
  namespace: omniroute
spec:
  replicas: 3
  selector:
    matchLabels:
      app: gig-platform
  template:
    metadata:
      labels:
        app: gig-platform
    spec:
      containers:
      - name: gig-platform
        image: omniroute/gig-platform:latest
        ports:
        - containerPort: 8082
        envFrom:
        - configMapRef:
            name: omniroute-config
        - secretRef:
            name: omniroute-secrets
        resources:
          requests:
            memory: "256Mi"
            cpu: "200m"
          limits:
            memory: "1Gi"
            cpu: "1"

---
apiVersion: v1
kind: Service
metadata:
  name: gig-platform
  namespace: omniroute
spec:
  selector:
    app: gig-platform
  ports:
  - port: 8082
    targetPort: 8082

---
# Notification Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: notification-service
  namespace: omniroute
spec:
  replicas: 2
  selector:
    matchLabels:
      app: notification-service
  template:
    metadata:
      labels:
        app: notification-service
    spec:
      containers:
      - name: notification-service
        image: omniroute/notification-service:latest
        ports:
        - containerPort: 8083
        envFrom:
        - configMapRef:
            name: omniroute-config
        - secretRef:
            name: omniroute-secrets

---
apiVersion: v1
kind: Service
metadata:
  name: notification-service
  namespace: omniroute
spec:
  selector:
    app: notification-service
  ports:
  - port: 8083
    targetPort: 8083

---
# Payment Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: payment-service
  namespace: omniroute
spec:
  replicas: 3
  selector:
    matchLabels:
      app: payment-service
  template:
    metadata:
      labels:
        app: payment-service
    spec:
      containers:
      - name: payment-service
        image: omniroute/payment-service:latest
        ports:
        - containerPort: 8084
        envFrom:
        - configMapRef:
            name: omniroute-config
        - secretRef:
            name: omniroute-secrets
        resources:
          requests:
            memory: "256Mi"
            cpu: "200m"
          limits:
            memory: "1Gi"
            cpu: "1"

---
apiVersion: v1
kind: Service
metadata:
  name: payment-service
  namespace: omniroute
spec:
  selector:
    app: payment-service
  ports:
  - port: 8084
    targetPort: 8084

---
# Forecasting Service (Python)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: forecasting-service
  namespace: omniroute
spec:
  replicas: 2
  selector:
    matchLabels:
      app: forecasting-service
  template:
    metadata:
      labels:
        app: forecasting-service
    spec:
      containers:
      - name: forecasting-service
        image: omniroute/forecasting-service:latest
        ports:
        - containerPort: 8107
        envFrom:
        - configMapRef:
            name: omniroute-config
        - secretRef:
            name: omniroute-secrets
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "2"

---
apiVersion: v1
kind: Service
metadata:
  name: forecasting-service
  namespace: omniroute
spec:
  selector:
    app: forecasting-service
  ports:
  - port: 8107
    targetPort: 8107

---
# Credit Scoring Service (Python)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: credit-scoring-service
  namespace: omniroute
spec:
  replicas: 2
  selector:
    matchLabels:
      app: credit-scoring-service
  template:
    metadata:
      labels:
        app: credit-scoring-service
    spec:
      containers:
      - name: credit-scoring-service
        image: omniroute/credit-scoring-service:latest
        ports:
        - containerPort: 8108
        envFrom:
        - configMapRef:
            name: omniroute-config
        - secretRef:
            name: omniroute-secrets
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "2"

---
apiVersion: v1
kind: Service
metadata:
  name: credit-scoring-service
  namespace: omniroute
spec:
  selector:
    app: credit-scoring-service
  ports:
  - port: 8108
    targetPort: 8108

---
# Recommendations Service (Python)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: recommendations-service
  namespace: omniroute
spec:
  replicas: 2
  selector:
    matchLabels:
      app: recommendations-service
  template:
    metadata:
      labels:
        app: recommendations-service
    spec:
      containers:
      - name: recommendations-service
        image: omniroute/recommendations-service:latest
        ports:
        - containerPort: 8109
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "2"

---
apiVersion: v1
kind: Service
metadata:
  name: recommendations-service
  namespace: omniroute
spec:
  selector:
    app: recommendations-service
  ports:
  - port: 8109
    targetPort: 8109

---
# Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: omniroute-ingress
  namespace: omniroute
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/rate-limit: "100"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
spec:
  tls:
  - hosts:
    - api.omniroute.io
    secretName: omniroute-tls
  rules:
  - host: api.omniroute.io
    http:
      paths:
      - path: /auth
        pathType: Prefix
        backend:
          service:
            name: auth-service
            port:
              number: 8100
      - path: /products
        pathType: Prefix
        backend:
          service:
            name: catalog-service
            port:
              number: 8101
      - path: /orders
        pathType: Prefix
        backend:
          service:
            name: order-service
            port:
              number: 8102
      - path: /pricing
        pathType: Prefix
        backend:
          service:
            name: pricing-engine
            port:
              number: 8081
      - path: /graphql
        pathType: Prefix
        backend:
          service:
            name: hasura
            port:
              number: 8080

---
# Horizontal Pod Autoscaler
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: order-service-hpa
  namespace: omniroute
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: order-service
  minReplicas: 3
  maxReplicas: 20
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80

---
# Pod Disruption Budget
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: order-service-pdb
  namespace: omniroute
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app: order-service
