# OmniRoute - System Architecture

## High-Level Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                   CLIENTS                                            │
├─────────────────────────────────────────────────────────────────────────────────────┤
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐│
│  │  Mobile  │  │   Web    │  │   USSD   │  │ WhatsApp │  │  Voice   │  │   SMS    ││
│  │(Flutter) │  │ (React)  │  │ Gateway  │  │   Bot    │  │   IVR    │  │ Gateway  ││
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘│
└───────┼─────────────┼─────────────┼─────────────┼─────────────┼─────────────┼──────┘
        │             │             │             │             │             │
        └─────────────┴─────────────┴──────┬──────┴─────────────┴─────────────┘
                                           │
┌──────────────────────────────────────────▼──────────────────────────────────────────┐
│                               API GATEWAY LAYER                                      │
├─────────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────────────────────┐│
│  │                        Hasura GraphQL Engine                                    ││
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐││
│  │  │   Queries   │  │  Mutations  │  │Subscriptions│  │   Actions (Webhooks)   │││
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────────────┘││
│  └─────────────────────────────────────────────────────────────────────────────────┘│
├─────────────────────────────────────────────────────────────────────────────────────┤
│                              AUTHENTICATION                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐│
│  │  JWT Validation  │  OAuth 2.0  │  API Keys  │  Rate Limiting  │  RBAC          ││
│  └─────────────────────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────────────────────┘
                                           │
┌──────────────────────────────────────────▼──────────────────────────────────────────┐
│                              MICROSERVICES LAYER                                     │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐    │
│  │ PRICING ENGINE │  │  GIG PLATFORM  │  │  NOTIFICATION  │  │    PAYMENT     │    │
│  │     :8081      │  │     :8082      │  │    SERVICE     │  │    SERVICE     │    │
│  │                │  │                │  │     :8083      │  │     :8084      │    │
│  │ • Base pricing │  │ • Workers      │  │                │  │                │    │
│  │ • Promotions   │  │ • Tasks        │  │ • Push         │  │ • Processing   │    │
│  │ • Discounts    │  │ • Allocations  │  │ • SMS          │  │ • Invoicing    │    │
│  │ • Tax calc     │  │ • Earnings     │  │ • Email        │  │ • Credit       │    │
│  │ • Contracts    │  │ • Proofs       │  │ • WhatsApp     │  │ • Settlement   │    │
│  └────────────────┘  └────────────────┘  └────────────────┘  └────────────────┘    │
│                                                                                      │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐    │
│  │  SCE SERVICE   │  │  BANK GATEWAY  │  │  ATC SERVICE   │  │ROUTE OPTIMIZER │    │
│  │     :8085      │  │     :8086      │  │     :8087      │  │     :8088      │    │
│  │                │  │                │  │                │  │   (Python)     │    │
│  │ • Workflows    │  │ • NIBSS        │  │ • Grants       │  │                │    │
│  │ • Service Def  │  │ • Mobile Money │  │ • Collections  │  │ • VRP Solving  │    │
│  │ • Rust Compile │  │ • Virtual Acct │  │ • Settlements  │  │ • Time Windows │    │
│  │ • Versioning   │  │ • Webhooks     │  │ • Commissions  │  │ • Capacity     │    │
│  └────────────────┘  └────────────────┘  └────────────────┘  └────────────────┘    │
│                                                                                      │
│  ┌────────────────┐                                                                 │
│  │  WMS SERVICE   │                                                                 │
│  │     :8089      │                                                                 │
│  │                │                                                                 │
│  │ • Zones        │                                                                 │
│  │ • Locations    │                                                                 │
│  │ • Pick paths   │                                                                 │
│  │ • Wave plan    │                                                                 │
│  └────────────────┘                                                                 │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                           │
┌──────────────────────────────────────────▼──────────────────────────────────────────┐
│                             WORKFLOW ORCHESTRATION                                   │
├─────────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────────────────────┐│
│  │                           Temporal Workflow Engine                              ││
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐││
│  │  │Order Fulfill│  │  Payment    │  │ Settlement  │  │   Service Creation     │││
│  │  │  Workflow   │  │  Workflow   │  │  Workflow   │  │      Workflow          │││
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────────────┘││
│  └─────────────────────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────────────────────┘
                                           │
┌──────────────────────────────────────────▼──────────────────────────────────────────┐
│                                DATA LAYER                                            │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  ┌──────────────────────┐  ┌──────────────────────┐  ┌──────────────────────────┐  │
│  │      YugabyteDB      │  │     DragonflyDB      │  │       Redpanda           │  │
│  │    (Primary DB)      │  │       (Cache)        │  │   (Event Streaming)      │  │
│  ├──────────────────────┤  ├──────────────────────┤  ├──────────────────────────┤  │
│  │ • PostgreSQL compat  │  │ • Redis compatible   │  │ • Kafka compatible       │  │
│  │ • Distributed        │  │ • 25x memory savings │  │ • No ZooKeeper           │  │
│  │ • Multi-region       │  │ • Multi-threaded     │  │ • Schema Registry        │  │
│  │ • Auto-sharding      │  │ • Fast snapshots     │  │ • Low latency (<10ms)    │  │
│  │ :5433                │  │ :6379                │  │ :9093                    │  │
│  └──────────────────────┘  └──────────────────────┘  └──────────────────────────┘  │
│                                                                                      │
│  ┌──────────────────────┐  ┌──────────────────────┐                                 │
│  │       MinIO          │  │    TimescaleDB       │                                 │
│  │   (Object Storage)   │  │   (Time-Series)      │                                 │
│  ├──────────────────────┤  ├──────────────────────┤                                 │
│  │ • S3 compatible      │  │ • Telemetry data     │                                 │
│  │ • Documents, images  │  │ • Vehicle tracking   │                                 │
│  │ :9000                │  │ • IoT sensors        │                                 │
│  └──────────────────────┘  └──────────────────────┘                                 │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                           │
┌──────────────────────────────────────────▼──────────────────────────────────────────┐
│                              OBSERVABILITY                                           │
├─────────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                │
│  │ Prometheus  │  │   Grafana   │  │   Jaeger    │  │ Alert-      │                │
│  │  (Metrics)  │  │(Dashboards) │  │  (Tracing)  │  │  manager    │                │
│  │   :9090     │  │   :3000     │  │   :16686    │  │             │                │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘                │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Data Flow Architecture

### Order Processing Flow

```
┌─────────┐    ┌─────────┐    ┌─────────────┐    ┌──────────┐    ┌─────────┐
│ Customer│───▶│  Hasura │───▶│ Order Event │───▶│ Temporal │───▶│Warehouse│
│  App    │    │ GraphQL │    │  (Redpanda) │    │ Workflow │    │   WMS   │
└─────────┘    └────┬────┘    └─────────────┘    └────┬─────┘    └────┬────┘
                    │                                  │               │
                    ▼                                  ▼               ▼
              ┌──────────┐                      ┌──────────┐     ┌──────────┐
              │ Pricing  │                      │ Payment  │     │  Route   │
              │ Engine   │                      │ Service  │     │Optimizer │
              └──────────┘                      └──────────┘     └──────────┘
                                                      │               │
                                                      ▼               ▼
                                                ┌──────────┐     ┌──────────┐
                                                │  Bank    │     │   Gig    │
                                                │ Gateway  │     │ Platform │
                                                └──────────┘     └──────────┘
```

### Payment Flow

```
┌─────────┐    ┌─────────────┐    ┌───────────┐    ┌──────────┐
│ Customer│───▶│   Payment   │───▶│   Bank    │───▶│   NIBSS  │
│  Order  │    │   Service   │    │  Gateway  │    │  / MoMo  │
└─────────┘    └──────┬──────┘    └─────┬─────┘    └────┬─────┘
                      │                 │               │
                      ▼                 ▼               ▼
               ┌──────────┐      ┌──────────┐    ┌──────────┐
               │ Temporal │      │  Webhook │    │ External │
               │ Workflow │◀─────│ Callback │◀───│   Bank   │
               └──────────┘      └──────────┘    └──────────┘
                      │
                      ▼
               ┌──────────┐
               │Settlement│
               │  Batch   │
               └──────────┘
```

---

## Domain Model Architecture

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        BOUNDED CONTEXTS                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐         │
│  │    COMMERCE     │  │   GIG PLATFORM  │  │    PAYMENTS     │         │
│  ├─────────────────┤  ├─────────────────┤  ├─────────────────┤         │
│  │ Aggregates:     │  │ Aggregates:     │  │ Aggregates:     │         │
│  │ • Product       │  │ • GigWorker     │  │ • Payment       │         │
│  │ • Order         │  │ • Task          │  │ • Invoice       │         │
│  │ • Customer      │  │ • Allocation    │  │ • CreditAccount │         │
│  │ • Inventory     │  │ • Earning       │  │ • Settlement    │         │
│  │                 │  │ • Payout        │  │                 │         │
│  │ Value Objects:  │  │                 │  │ Value Objects:  │         │
│  │ • Money         │  │ Value Objects:  │  │ • Money         │         │
│  │ • PriceList     │  │ • Location      │  │ • AccountDetails│         │
│  │ • Quantity      │  │ • TimeWindow    │  │ • PaymentRail   │         │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘         │
│                                                                          │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐         │
│  │   DISTRIBUTION  │  │   FINANCIAL     │  │  NOTIFICATIONS  │         │
│  ├─────────────────┤  ├─────────────────┤  ├─────────────────┤         │
│  │ Aggregates:     │  │ Aggregates:     │  │ Aggregates:     │         │
│  │ • Vehicle       │  │ • ATCGrant      │  │ • Notification  │         │
│  │ • Route         │  │ • VirtualAccount│  │ • Template      │         │
│  │ • Warehouse     │  │ • BankConnection│  │ • Device        │         │
│  │ • Location      │  │                 │  │ • USSDSession   │         │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘         │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Deployment Architecture

### Kubernetes Deployment

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     KUBERNETES CLUSTER                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────────────────────── NAMESPACES ─────────────────────────────┐ │
│  │                                                                     │ │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐   │ │
│  │  │ omniroute  │  │  database  │  │ messaging  │  │observability│   │ │
│  │  │ (services) │  │            │  │            │  │             │   │ │
│  │  └────────────┘  └────────────┘  └────────────┘  └────────────┘   │ │
│  │                                                                     │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                          │
│  ┌─────────────────────────── SERVICES ───────────────────────────────┐ │
│  │                                                                     │ │
│  │  Deployments (HPA enabled):                                        │ │
│  │  • pricing-engine (2-10 replicas)                                  │ │
│  │  • gig-platform (2-10 replicas)                                    │ │
│  │  • payment-service (3-15 replicas)                                 │ │
│  │  • notification-service (2-8 replicas)                             │ │
│  │  • bank-gateway (2-10 replicas)                                    │ │
│  │                                                                     │ │
│  │  StatefulSets:                                                     │ │
│  │  • yugabytedb (3 replicas)                                         │ │
│  │  • dragonfly (3 replicas)                                          │ │
│  │  • redpanda (3 replicas)                                           │ │
│  │                                                                     │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                          │
│  ┌─────────────────────────── INGRESS ────────────────────────────────┐ │
│  │                                                                     │ │
│  │  ┌────────────────────────────────────────────────────────────┐   │ │
│  │  │                    Nginx Ingress Controller                 │   │ │
│  │  │  • TLS termination                                          │   │ │
│  │  │  • Rate limiting                                            │   │ │
│  │  │  • Path-based routing                                       │   │ │
│  │  └────────────────────────────────────────────────────────────┘   │ │
│  │                                                                     │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Multi-Region Architecture

```
                           ┌─────────────────┐
                           │  Global Load    │
                           │   Balancer      │
                           └────────┬────────┘
                                    │
           ┌────────────────────────┼────────────────────────┐
           │                        │                        │
           ▼                        ▼                        ▼
   ┌───────────────┐        ┌───────────────┐        ┌───────────────┐
   │   LAGOS       │        │   NAIROBI     │        │   CAPE TOWN   │
   │   Region      │        │   Region      │        │   Region      │
   ├───────────────┤        ├───────────────┤        ├───────────────┤
   │               │        │               │        │               │
   │ ┌───────────┐ │        │ ┌───────────┐ │        │ ┌───────────┐ │
   │ │    K8s    │ │        │ │    K8s    │ │        │ │    K8s    │ │
   │ │  Cluster  │ │        │ │  Cluster  │ │        │ │  Cluster  │ │
   │ └───────────┘ │        │ └───────────┘ │        │ └───────────┘ │
   │               │        │               │        │               │
   │ ┌───────────┐ │        │ ┌───────────┐ │        │ ┌───────────┐ │
   │ │YugabyteDB │ │◀──────▶│ │YugabyteDB │ │◀──────▶│ │YugabyteDB │ │
   │ │  (Sync)   │ │        │ │  (Sync)   │ │        │ │  (Sync)   │ │
   │ └───────────┘ │        │ └───────────┘ │        │ └───────────┘ │
   │               │        │               │        │               │
   └───────────────┘        └───────────────┘        └───────────────┘
```
